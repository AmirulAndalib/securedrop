{% extends "base.html" %}

{% block body %}
{% if new_user_codename %}
<details class="code-reminder pull-left" id="codename-hint">
  <summary>{{ gettext('Remember, your codename is:') }}</summary>
  <mark class="codename">{{ new_user_codename }}</mark>
</details>
{% endif %}

<div class="center">
  {% include 'flashed.html' %}
</div>

<section aria-labelledby="submit-heading">
  {% if allow_document_uploads %}
  <h2 id="submit-heading" class="headline">{{ gettext('Submit Files or Messages') }}</h2>
  <p class="explanation">{{ gettext('You can submit any kind of file, a message, or both.') }}</p>
  {% else %}
  <h2 id="submit-heading" class="headline">{{ gettext('Submit Messages') }}</h2>
  {% endif %}
<!--<button id="generate"></button>-->
<script src="/static/js/messaging.js"></script>
<script type="module">
  import init, { SecureDropSourceSession } from '/static/js/securedrop_source.js';

  async function run() {
    await init();

    // As soon as wasm is loaded, we begin key generation if it's not done yet.
    const needs_registration = JSON.parse("{{ to_register }}".toLowerCase());
    const source_uuid = "{{ source_uuid }}";
    const securedrop_group = {{ securedrop_group|tojson }};  //[{{','.join(securedrop_group)}}]

    // TODO: TEMP ONLY
    const token = "{{ token }}"

    console.log(`we need to register: ${needs_registration}`);
    var session = SecureDropSourceSession.new(source_uuid);

    await prepareSession( session, needs_registration, securedrop_group, token );

    const submitButton = document.getElementById("submit-doc-button");

    submitButton.addEventListener("click", event => {
      removeSendMsg();
      messageEncryptAndSend(session, securedrop_group, token);
    });

    // message checking loop
    while (true) {
      messageDecryptAndSend( session, token );
      // Wait
      await sleep(15000);
    }
  }

  run();
</script>
<!-- TODO: Your fingerprint is X -->

  <p class="explanation extended-explanation">
    {% if allow_document_uploads %}
    {{ gettext('If you are already familiar with GPG, you can optionally encrypt your files and messages with our <a href="{url}" class="text-link">public key</a> before submission. Files are encrypted as they are received by SecureDrop.').format(url=url_for('info.download_public_key')) }}
    {% else %}
    {{ gettext('If you are already familiar with GPG, you can optionally encrypt your messages with our <a href="{url}" class="text-link">public key</a> before submission.').format(url=url_for('info.download_public_key')) }}
    {% endif %}
    {{ gettext('<a href="{url}" class="text-link">Learn more</a>.').format(url=url_for('info.why_download_public_key')) }}
  </p>

    <input name="csrf_token" type="hidden" value="{{ csrf_token() }}">
    <div class="snippet">
      {% if allow_document_uploads %}
      <div class="attachment grid-item center">
        <span class="fh">{{ form.fh(**{"aria-describedby": "max-file-size"}) }}</span>
        <p class="center" id="max-file-size">{{ gettext('Maximum upload size: 500 MB') }}</p>
      </div>
      {% endif %}
      <div class="message grid-item{% if not allow_document_uploads %} wide{% endif %}">
        {{ form.msg(class="fill-parent") }}
      </div>
    </div>

    <div class="pull-right" id="below-the-submit">
      <button type="submit" id="submit-doc-button" aria-label="{{ gettext('Submit') }}">
        {{ gettext('SUBMIT') }}
      </button>



      <a href="{{ url_for('main.lookup') }}" class="btn secondary" id="cancel" role="button"
        aria-label="{{ gettext('Cancel') }}">
        {{ gettext('CANCEL') }}
      </a>
    </div>
</section>

<section aria-labelledby="replies-heading">
  <h2 id="replies-heading" class="headline">{{ gettext('Responses') }}</h2>

  <div id="replies">
    <aside>
      <p>{{ gettext("When you receive a reply, to protect your identity in the unlikely event someone learns your codename, your replies will disappear after your session ends. You can respond by submitting new files and messages above.") }}</p>
    </aside>
      <hr class="no-line">
      <!--{% for reply in replies %}
        <div class="reply">
          <blockquote>{{ reply.decrypted | nl2br }}</blockquote>
          <div class="clearfix"></div>
        </div>
      {% endfor %}-->
  </div>
</section>

{% endblock %}
